(()=>{class e{constructor(){this.providers=[],this.ws=null,this.isComparing=!1,this.responses={provider1:"",provider2:""},this.stats={provider1:{firstTokenTime:null,totalTime:null,completionTokens:0,tps:0},provider2:{firstTokenTime:null,totalTime:null,completionTokens:0,tps:0}},this.init()}async init(){await this.loadProviders(),this.setupEventListeners(),this.setupWebSocket(),this.populateProviderSelects()}async loadProviders(){try{const e=await fetch("/api/providers"),t=await e.json();this.providers=t.providers}catch(e){console.error("Failed to load providers:",e),this.showError("Failed to load providers")}}setupEventListeners(){document.getElementById("compare-btn").addEventListener("click",()=>{this.compareResponses()}),document.getElementById("clear-btn").addEventListener("click",()=>{this.clearResponses()})}setupWebSocket(){const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}`;console.log("Connecting to WebSocket at:",e),this.ws=new WebSocket(e),this.ws.onopen=()=>{console.log("WebSocket connected successfully")},this.ws.onmessage=e=>{try{const t=JSON.parse(e.data);console.log("WebSocket message received:",t),this.handleWebSocketMessage(t)}catch(t){console.error("Failed to parse WebSocket message:",t,e.data)}},this.ws.onerror=e=>{console.error("WebSocket error:",e),this.showError("WebSocket connection error. Check console for details.")},this.ws.onclose=e=>{console.log("WebSocket disconnected. Code:",e.code,"Reason:",e.reason),setTimeout(()=>{console.log("Attempting to reconnect WebSocket..."),this.setupWebSocket()},3e3)}}handleWebSocketMessage(e){switch(e.type){case"STREAM":this.handleStream(e);break;case"STREAM_COMPLETE":this.handleStreamComplete(e);break;case"COMPLETE":this.handleComparisonComplete();break;case"ERROR":this.showError(e.message),this.enableCompareButton();break;case"PROVIDER_ERROR":this.handleProviderError(e)}}handleStream(e){const{provider:t,content:o,firstTokenTime:s,totalTime:n}=e,r=document.getElementById(`${t}-response`);document.getElementById(`${t}-stats`),this.responses[t]+=o,r.textContent=this.responses[t],r.scrollTop=r.scrollHeight,s&&(this.stats[t].firstTokenTime=s),n&&(this.stats[t].totalTime=n),this.updateStats(t)}handleStreamComplete(e){const{provider:t,fullResponse:o,firstTokenTime:s,totalTime:n,completionTokens:r,tps:i}=e,l=document.getElementById(`${t}-response`),c=(document.getElementById(`${t}-stats`),l.closest(".response-panel"));this.responses[t]=o,l.textContent=o,l.scrollTop=l.scrollHeight,this.stats[t]={firstTokenTime:s,totalTime:n,completionTokens:r,tps:i},this.updateStats(t),l.classList.remove("streaming"),c.classList.add("completed");const d=c.querySelector(".response-header");if(!d.querySelector(".completion-badge")){const e=document.createElement("span");e.className="completion-badge",e.textContent="âœ“ Complete",d.appendChild(e)}}handleComparisonComplete(){this.isComparing=!1,this.enableCompareButton(),this.showSuccess("Comparison complete!")}handleProviderError(e){const{provider:t,message:o}=e,s=document.getElementById(`${t}-response`);s.innerHTML=`<div class="error">Error: ${o}</div>`,s.classList.remove("streaming")}updateStats(e){const t=document.getElementById(`${e}-stats`),{firstTokenTime:o,totalTime:s,completionTokens:n,tps:r}=this.stats[e];let i="";o&&(i+=`First token: ${o}ms`),s&&(i&&(i+=" | "),i+=`Total: ${s}ms`),n>0&&(i&&(i+=" | "),i+=`Tokens: ${n}`),r>0&&(i&&(i+=" | "),i+=`TPS: ${r}`),t.textContent=i}populateProviderSelects(){const e=document.getElementById("provider1-select"),t=document.getElementById("provider2-select");e.innerHTML='<option value="">Select a provider</option>',t.innerHTML='<option value="">Select a provider</option>',this.providers.forEach(o=>{const s=new Option(o.name,o.id),n=new Option(o.name,o.id);e.add(s),t.add(n)})}async compareResponses(){if(this.isComparing)return;const e=document.getElementById("provider1-select").value,t=document.getElementById("provider2-select").value,o=document.getElementById("prompt-input").value.trim();if(!e||!t)return void this.showError("Please select both providers");if(!o)return void this.showError("Please enter a prompt");if(e===t)return void this.showError("Please select different providers");this.isComparing=!0,this.disableCompareButton(),this.clearResponses();const s=this.providers.find(t=>t.id===e),n=this.providers.find(e=>e.id===t);document.getElementById("provider1-title").textContent=s.name,document.getElementById("provider2-title").textContent=n.name,document.getElementById("provider1-response").classList.add("streaming"),document.getElementById("provider2-response").classList.add("streaming"),this.ws.send(JSON.stringify({type:"COMPARE",prompt:o,provider1Id:e,provider2Id:t}))}clearResponses(){this.responses={provider1:"",provider2:""},this.stats={provider1:{firstTokenTime:null,totalTime:null,completionTokens:0,tps:0},provider2:{firstTokenTime:null,totalTime:null,completionTokens:0,tps:0}},document.getElementById("provider1-response").textContent="",document.getElementById("provider2-response").textContent="",document.getElementById("provider1-stats").textContent="",document.getElementById("provider2-stats").textContent="",document.getElementById("provider1-response").classList.remove("streaming"),document.getElementById("provider2-response").classList.remove("streaming"),document.querySelectorAll(".response-panel").forEach(e=>{e.classList.remove("completed")}),document.querySelectorAll(".completion-badge").forEach(e=>{e.remove()})}disableCompareButton(){const e=document.getElementById("compare-btn");e.disabled=!0,e.textContent="Comparing..."}enableCompareButton(){const e=document.getElementById("compare-btn");e.disabled=!1,e.textContent="Compare Responses"}showError(e){document.querySelectorAll(".error").forEach(e=>e.remove());const t=document.createElement("div");t.className="error",t.textContent=e;const o=document.querySelector(".container");o.insertBefore(t,o.firstChild),setTimeout(()=>{t.remove()},5e3)}showSuccess(e){document.querySelectorAll(".success").forEach(e=>e.remove());const t=document.createElement("div");t.className="success",t.textContent=e;const o=document.querySelector(".container");o.insertBefore(t,o.firstChild),setTimeout(()=>{t.remove()},3e3)}}document.addEventListener("DOMContentLoaded",()=>{window.app=new e})})();